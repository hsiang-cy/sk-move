# skMove 前端 Vue → React 遷移步驟

## 技術棧對照

| 角色 | 現在（Vue） | React 版 |
|------|------------|---------|
| 框架 | Vue 3 Composition API | React 19 |
| 路由 | vue-router 5 | TanStack Router |
| 客戶端狀態 | Pinia | Zustand |
| 伺服器狀態 | Pinia（手動 loading/error） | TanStack Query |
| HTTP | Axios | Axios（直接複製） |
| CSS | Tailwind 4 + DaisyUI 5 | 直接複製，不動 |
| 圖示 | lucide-vue-next | lucide-react |
| 建構 | Vite 7 | Vite 7（換 React plugin） |

---

## 可直接複製、不需改動的檔案

| 路徑 | 備註 |
|------|------|
| `src/assets/main.css` | Tailwind / DaisyUI / 自訂主題 |
| `src/services/api.ts` | Axios 實例與 interceptors |
| `src/services/auth.ts` | Auth API |
| `src/services/locations.ts` | Locations API |
| `src/services/vehicles.ts` | Vehicles API |
| `src/services/vehicleTypes.ts` | VehicleTypes API |
| `src/types/index.ts` | TypeScript interfaces |
| `src/lib/utils.ts` | formatTimeWindow, formatLimit |
| `.env` / `env.d.ts` | 環境變數定義 |

> **services 層完全不動**是本次遷移最大的優勢，商業邏輯完整保留。

---

## STEP 0 — 建立新專案

```bash
pnpm create vite sk-move-react --template react-ts
cd sk-move-react
```

### 安裝依賴

```bash
pnpm add \
  @tanstack/react-router \
  @tanstack/router-devtools \
  @tanstack/react-query \
  @tanstack/react-query-devtools \
  zustand \
  axios \
  lucide-react \
  @tailwindcss/vite \
  daisyui

pnpm add -D \
  tailwindcss \
  @tanstack/router-plugin \
  typescript
```

### vite.config.ts

```ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import tailwindcss from '@tailwindcss/vite'
import { TanStackRouterVite } from '@tanstack/router-plugin/vite'
import path from 'path'

export default defineConfig({
  plugins: [
    TanStackRouterVite(),   // 必須在 react() 之前
    react(),
    tailwindcss(),
  ],
  resolve: {
    alias: { '@': path.resolve(__dirname, './src') },
  },
})
```

### tsconfig.json（加 path alias）

```json
{
  "compilerOptions": {
    "paths": { "@/*": ["./src/*"] }
  }
}
```

---

## STEP 1 — 複製靜態資源與 Service 層

```
src/assets/main.css      ← 直接複製
src/services/            ← 整個目錄複製
src/types/index.ts       ← 直接複製
src/lib/utils.ts         ← 直接複製
```

---

## STEP 2 — Zustand Auth Store

> 原 Pinia `useAuthStore` → Zustand，結構幾乎 1:1。

```ts
// src/stores/auth.ts
import { create } from 'zustand'
import { authService } from '@/services/auth'
import type { AuthUser, LoginCredentials } from '@/types'

interface AuthState {
  token: string | null
  user: AuthUser | null
  isAuthenticated: boolean
  login: (credentials: LoginCredentials) => Promise<void>
  logout: () => Promise<void>
}

export const useAuthStore = create<AuthState>((set, get) => ({
  token: localStorage.getItem('auth_token'),
  user: null,
  get isAuthenticated() { return !!get().token },

  async login(credentials) {
    const res = await authService.login(credentials)
    localStorage.setItem('auth_token', res.token)
    set({ token: res.token, user: res.user })
  },

  async logout() {
    try { await authService.logout() } catch {}
    finally {
      localStorage.removeItem('auth_token')
      set({ token: null, user: null })
    }
  },
}))
```

---

## STEP 3 — TanStack Router（路由 + Auth Guard）

TanStack Router 使用 **檔案路由**，在 `src/routes/` 下建立以下檔案：

```
src/routes/
├── __root.tsx              ← 根 layout，放 auth guard
├── login.tsx               ← /login
├── _auth.tsx               ← 受保護的 layout route（AppLayout）
├── _auth.locations.tsx     ← /locations
├── _auth.vehicles.tsx      ← /vehicles
└── _auth.vehicle-types.tsx ← /vehicle-types
```

### `__root.tsx` — 根路由（Auth Guard）

```tsx
// src/routes/__root.tsx
import { createRootRoute, Outlet, redirect } from '@tanstack/react-router'
import { useAuthStore } from '@/stores/auth'

export const Route = createRootRoute({
  beforeLoad: ({ location }) => {
    const isAuthenticated = useAuthStore.getState().isAuthenticated
    const isLoginPage = location.pathname === '/login'

    if (!isAuthenticated && !isLoginPage) {
      throw redirect({ to: '/login' })
    }
    if (isAuthenticated && isLoginPage) {
      throw redirect({ to: '/locations' })
    }
  },
  component: () => <Outlet />,
})
```

### `login.tsx`

```tsx
// src/routes/login.tsx
import { createFileRoute } from '@tanstack/react-router'
import LoginPage from '@/views/LoginView'

export const Route = createFileRoute('/login')({
  component: LoginPage,
})
```

### `_auth.tsx` — AppLayout wrapper

```tsx
// src/routes/_auth.tsx
import { createFileRoute, Outlet } from '@tanstack/react-router'
import AppLayout from '@/components/layout/AppLayout'

export const Route = createFileRoute('/_auth')({
  component: () => (
    <AppLayout>
      <Outlet />
    </AppLayout>
  ),
})
```

### `_auth.locations.tsx`

```tsx
// src/routes/_auth.locations.tsx
import { createFileRoute } from '@tanstack/react-router'
import LocationsView from '@/views/LocationsView'

export const Route = createFileRoute('/_auth/locations')({
  component: LocationsView,
})
```

> `_auth.vehicles.tsx` 與 `_auth.vehicle-types.tsx` 結構相同，依樣畫葫蘆。

### `main.tsx`

```tsx
// src/main.tsx
import React from 'react'
import ReactDOM from 'react-dom/client'
import { RouterProvider, createRouter } from '@tanstack/react-router'
import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
import { routeTree } from './routeTree.gen'  // 自動產生
import './assets/main.css'

const router = createRouter({ routeTree })
const queryClient = new QueryClient()

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <QueryClientProvider client={queryClient}>
      <RouterProvider router={router} />
    </QueryClientProvider>
  </React.StrictMode>,
)
```

---

## STEP 4 — Layout 元件

### `AppLayout.tsx`

> 原 `AppLayout.vue`：DaisyUI Drawer 結構完全相同，`<RouterView />` 換成 `children` prop。

```tsx
// src/components/layout/AppLayout.tsx
import { Menu } from 'lucide-react'
import AppSidebar from './AppSidebar'

export default function AppLayout({ children }: { children: React.ReactNode }) {
  return (
    <div className="drawer lg:drawer-open min-h-screen">
      <input id="app-drawer" type="checkbox" className="drawer-toggle" />

      <div className="drawer-content flex flex-col bg-base-200 min-h-screen">
        {/* Mobile topbar */}
        <header className="navbar bg-base-100 border-b border-base-300 lg:hidden px-4 min-h-14">
          <label htmlFor="app-drawer" className="btn btn-ghost btn-square btn-sm">
            <Menu className="w-5 h-5" />
          </label>
          <span className="font-bold text-base ml-2">skMove</span>
        </header>

        <main className="flex-1 p-6 max-w-screen-xl">
          {children}
        </main>
      </div>

      <div className="drawer-side z-40">
        <label htmlFor="app-drawer" className="drawer-overlay" aria-label="關閉選單" />
        <AppSidebar />
      </div>
    </div>
  )
}
```

### `AppSidebar.tsx`

> `RouterLink` → TanStack Router 的 `Link`；active 狀態用 `Link` 的 `activeProps`。

```tsx
// src/components/layout/AppSidebar.tsx
import { Link, useNavigate } from '@tanstack/react-router'
import { MapPin, Truck, Tag, LogOut } from 'lucide-react'
import { useAuthStore } from '@/stores/auth'

const navItems = [
  { to: '/locations',     icon: MapPin, label: '地點管理' },
  { to: '/vehicles',      icon: Truck,  label: '車輛管理' },
  { to: '/vehicle-types', icon: Tag,    label: '車輛類型' },
] as const

export default function AppSidebar() {
  const logout = useAuthStore((s) => s.logout)
  const navigate = useNavigate()

  async function handleLogout() {
    await logout()
    navigate({ to: '/login' })
  }

  return (
    <aside className="flex flex-col w-64 min-h-full bg-base-100 border-r border-base-300">
      {/* Logo */}
      <div className="flex items-center gap-2.5 px-5 py-4 border-b border-base-300">
        <div className="w-8 h-8 rounded-lg bg-primary flex items-center justify-center shrink-0">
          <MapPin className="w-4 h-4 text-primary-content" />
        </div>
        <div>
          <span className="font-bold text-base leading-none tracking-tight">skMove</span>
          <p className="text-[10px] text-base-content/40 mt-0.5">路線規劃管理</p>
        </div>
      </div>

      {/* Navigation */}
      <nav className="flex-1 px-3 py-3">
        <p className="text-[10px] font-semibold text-base-content/35 uppercase tracking-widest px-3 mb-2">
          管理
        </p>
        <ul className="menu p-0 gap-0.5">
          {navItems.map(({ to, icon: Icon, label }) => (
            <li key={to}>
              <Link
                to={to}
                activeProps={{ className: 'active' }}
              >
                <Icon className="w-4 h-4" />
                {label}
              </Link>
            </li>
          ))}
        </ul>
      </nav>

      {/* Logout */}
      <div className="border-t border-base-300 px-3 py-3">
        <button
          className="btn btn-ghost btn-sm btn-block justify-start gap-2 text-base-content/60 hover:text-base-content"
          onClick={handleLogout}
        >
          <LogOut className="w-4 h-4" />
          登出
        </button>
      </div>
    </aside>
  )
}
```

---

## STEP 5 — 裝飾背景元件

### `MapBackground.tsx` ⚠️ 保留原始 SVG

> 登入頁背景地圖為手繪 SVG，直接搬移，CSS 改成 className，`<slot />` 改成 `children`。

```tsx
// src/components/inspira/MapBackground.tsx
export default function MapBackground({ children }: { children: React.ReactNode }) {
  return (
    <div className="map-wrap" style={styles.wrap}>
      <svg
        style={styles.svg}
        viewBox="0 0 1200 800"
        preserveAspectRatio="xMidYMid slice"
        xmlns="http://www.w3.org/2000/svg"
        aria-hidden="true"
      >
        {/* ── 底色 ── */}
        <rect width="1200" height="800" fill="#f7f6f4" />

        {/* 公園 */}
        <rect x="147" y="158" width="196" height="129" rx="10" fill="#d5e8d2" />
        <rect x="737" y="488" width="146" height="144" rx="10" fill="#d5e8d2" />

        {/* 公園樹木 */}
        <circle cx="183" cy="205" r="13" fill="#bad2b6" />
        <circle cx="220" cy="248" r="10" fill="#bad2b6" />
        <circle cx="265" cy="196" r="15" fill="#bad2b6" />
        <circle cx="312" cy="230" r="11" fill="#bad2b6" />
        <circle cx="194" cy="263" r="9"  fill="#bad2b6" />
        <circle cx="328" cy="188" r="12" fill="#bad2b6" />
        <circle cx="777" cy="530" r="12" fill="#bad2b6" />
        <circle cx="810" cy="570" r="9"  fill="#bad2b6" />
        <circle cx="848" cy="516" r="14" fill="#bad2b6" />
        <circle cx="872" cy="560" r="10" fill="#bad2b6" />

        {/* 街廓 */}
        <rect x="147"  y="8"   width="196" height="114" rx="8" fill="#eceae6" />
        <rect x="557"  y="8"   width="146" height="114" rx="8" fill="#eceae6" />
        <rect x="917"  y="8"   width="146" height="114" rx="8" fill="#eceae6" />
        <rect x="8"    y="158" width="105" height="129" rx="8" fill="#eceae6" />
        <rect x="377"  y="158" width="146" height="129" rx="8" fill="#eceae6" />
        <rect x="557"  y="158" width="146" height="129" rx="8" fill="#eceae6" />
        <rect x="917"  y="158" width="146" height="129" rx="8" fill="#eceae6" />
        <rect x="1097" y="158" width="95"  height="129" rx="8" fill="#eceae6" />
        <rect x="147"  y="323" width="196" height="129" rx="8" fill="#eceae6" />
        <rect x="737"  y="323" width="146" height="129" rx="8" fill="#eceae6" />
        <rect x="917"  y="323" width="146" height="129" rx="8" fill="#eceae6" />
        <rect x="147"  y="488" width="196" height="144" rx="8" fill="#eceae6" />
        <rect x="377"  y="488" width="146" height="144" rx="8" fill="#eceae6" />
        <rect x="917"  y="488" width="146" height="144" rx="8" fill="#eceae6" />
        <rect x="1097" y="488" width="95"  height="144" rx="8" fill="#eceae6" />
        <rect x="8"    y="668" width="105" height="124" rx="8" fill="#eceae6" />
        <rect x="147"  y="668" width="196" height="124" rx="8" fill="#eceae6" />
        <rect x="557"  y="668" width="146" height="124" rx="8" fill="#eceae6" />
        <rect x="737"  y="668" width="146" height="124" rx="8" fill="#eceae6" />

        {/* 斜向捷徑道路 */}
        <path d="M 360 470 L 540 305" stroke="#e3e2de" strokeWidth="17" strokeLinecap="round" />

        {/* 主幹道（水平） */}
        <rect x="0" y="130" width="1200" height="20" fill="#e3e2de" />
        <rect x="0" y="295" width="1200" height="20" fill="#e3e2de" />
        <rect x="0" y="460" width="1200" height="20" fill="#e3e2de" />
        <rect x="0" y="640" width="1200" height="20" fill="#e3e2de" />

        {/* 主幹道（垂直） */}
        <rect x="121"  y="0" width="18" height="800" fill="#e3e2de" />
        <rect x="351"  y="0" width="18" height="800" fill="#e3e2de" />
        <rect x="531"  y="0" width="18" height="800" fill="#e3e2de" />
        <rect x="711"  y="0" width="18" height="800" fill="#e3e2de" />
        <rect x="891"  y="0" width="18" height="800" fill="#e3e2de" />
        <rect x="1071" y="0" width="18" height="800" fill="#e3e2de" />

        {/* 道路中心線（虛線） */}
        <line x1="0"    y1="140" x2="1200" y2="140" stroke="#ccc9c3" strokeWidth="1.5" strokeDasharray="15 11" />
        <line x1="0"    y1="305" x2="1200" y2="305" stroke="#ccc9c3" strokeWidth="1.5" strokeDasharray="15 11" />
        <line x1="0"    y1="470" x2="1200" y2="470" stroke="#ccc9c3" strokeWidth="1.5" strokeDasharray="15 11" />
        <line x1="0"    y1="650" x2="1200" y2="650" stroke="#ccc9c3" strokeWidth="1.5" strokeDasharray="15 11" />
        <line x1="130"  y1="0" x2="130"  y2="800" stroke="#ccc9c3" strokeWidth="1.5" strokeDasharray="15 11" />
        <line x1="360"  y1="0" x2="360"  y2="800" stroke="#ccc9c3" strokeWidth="1.5" strokeDasharray="15 11" />
        <line x1="540"  y1="0" x2="540"  y2="800" stroke="#ccc9c3" strokeWidth="1.5" strokeDasharray="15 11" />
        <line x1="720"  y1="0" x2="720"  y2="800" stroke="#ccc9c3" strokeWidth="1.5" strokeDasharray="15 11" />
        <line x1="900"  y1="0" x2="900"  y2="800" stroke="#ccc9c3" strokeWidth="1.5" strokeDasharray="15 11" />
        <line x1="1080" y1="0" x2="1080" y2="800" stroke="#ccc9c3" strokeWidth="1.5" strokeDasharray="15 11" />

        {/* 圓環 */}
        <circle cx="720" cy="470" r="30" fill="#e3e2de" />
        <circle cx="720" cy="470" r="13" fill="#eceae6" />

        {/* 定位針 */}
        <g transform="translate(248, 218)" opacity="0.75">
          <path d="M0,16 C-4,10 -12,4 -12,-4 C-12,-12 -6,-18 0,-18 C6,-18 12,-12 12,-4 C12,4 4,10 0,16Z" fill="#8ab486" />
          <circle cx="0" cy="-5" r="5" fill="#eaf4e8" opacity="0.9" />
        </g>
        <g transform="translate(452, 215)" opacity="0.6">
          <path d="M0,16 C-4,10 -12,4 -12,-4 C-12,-12 -6,-18 0,-18 C6,-18 12,-12 12,-4 C12,4 4,10 0,16Z" fill="#bcb9b4" />
          <circle cx="0" cy="-5" r="5" fill="#f2f0ee" opacity="0.9" />
        </g>
        <g transform="translate(632, 58)" opacity="0.55">
          <path d="M0,16 C-4,10 -12,4 -12,-4 C-12,-12 -6,-18 0,-18 C6,-18 12,-12 12,-4 C12,4 4,10 0,16Z" fill="#bcb9b4" />
          <circle cx="0" cy="-5" r="5" fill="#f2f0ee" opacity="0.9" />
        </g>
        <g transform="translate(248, 562)" opacity="0.55">
          <path d="M0,16 C-4,10 -12,4 -12,-4 C-12,-12 -6,-18 0,-18 C6,-18 12,-12 12,-4 C12,4 4,10 0,16Z" fill="#bcb9b4" />
          <circle cx="0" cy="-5" r="5" fill="#f2f0ee" opacity="0.9" />
        </g>
        <g transform="translate(992, 222)" opacity="0.55">
          <path d="M0,16 C-4,10 -12,4 -12,-4 C-12,-12 -6,-18 0,-18 C6,-18 12,-12 12,-4 C12,4 4,10 0,16Z" fill="#bcb9b4" />
          <circle cx="0" cy="-5" r="5" fill="#f2f0ee" opacity="0.9" />
        </g>
      </svg>

      {children}
    </div>
  )
}

const styles = {
  wrap: {
    position: 'relative' as const,
    minHeight: '100dvh',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    overflow: 'hidden',
    backgroundColor: '#f7f6f4',
  },
  svg: {
    position: 'absolute' as const,
    inset: 0,
    width: '100%',
    height: '100%',
    pointerEvents: 'none' as const,
    userSelect: 'none' as const,
  },
}
```

---

## STEP 6 — TanStack Query Hooks（取代 Pinia CRUD Stores）

> 每個資源建一個 hooks 檔，完全取代原 Pinia store 的 fetchAll / create / update / remove。

### `src/hooks/useLocations.ts`

```ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { locationsService } from '@/services/locations'
import type { Location } from '@/types'

export function useLocations() {
  return useQuery({
    queryKey: ['locations'],
    queryFn: locationsService.getAll,
  })
}

export function useCreateLocation() {
  const qc = useQueryClient()
  return useMutation({
    mutationFn: (data: Omit<Location, 'id'>) => locationsService.create(data),
    onSuccess: () => qc.invalidateQueries({ queryKey: ['locations'] }),
  })
}

export function useUpdateLocation() {
  const qc = useQueryClient()
  return useMutation({
    mutationFn: ({ id, data }: { id: string; data: Omit<Location, 'id'> }) =>
      locationsService.update(id, data),
    onSuccess: () => qc.invalidateQueries({ queryKey: ['locations'] }),
  })
}

export function useDeleteLocation() {
  const qc = useQueryClient()
  return useMutation({
    mutationFn: (id: string) => locationsService.remove(id),
    onSuccess: () => qc.invalidateQueries({ queryKey: ['locations'] }),
  })
}
```

> `useVehicles.ts` 與 `useVehicleTypes.ts` 結構完全相同，queryKey 改為 `['vehicles']` / `['vehicleTypes']`。

---

## STEP 7 — Vue 語法 → React JSX 速查

| Vue | React |
|-----|-------|
| `ref(false)` | `useState(false)` |
| `computed(() => x)` | `useMemo(() => x, [deps])` |
| `watch(prop, fn)` | `useEffect(() => { fn() }, [prop])` |
| `onMounted(() => fn())` | `useEffect(() => { fn() }, [])` |
| `v-if="x"` | `{x && <El />}` 或三元 |
| `v-for="item in list"` | `{list.map(item => <El key={item.id} />)}` |
| `v-model="val"` | `value={val} onChange={e => setVal(e.target.value)}` |
| `v-model.number="val"` | `valueAsNumber` 或 `Number(e.target.value)` |
| `@click="fn"` | `onClick={fn}` |
| `@submit.prevent="fn"` | `onSubmit={e => { e.preventDefault(); fn() }}` |
| `:disabled="bool"` | `disabled={bool}` |
| `ref="dialogRef"` | `const dialogRef = useRef<HTMLDialogElement>(null)` |
| `defineProps` | function props |
| `defineEmits / emit('saved')` | callback prop `onSaved?: () => void` |
| `<slot />` | `{children}` |
| `<RouterLink to="...">` | `<Link to="...">` (TanStack Router) |
| `router.push('/login')` | `navigate({ to: '/login' })` |
| `class="..."` | `className="..."` |
| `stroke-width` | `strokeWidth` |
| `stroke-dasharray` | `strokeDasharray` |

---

## STEP 8 — LoginView.tsx

```tsx
// src/views/LoginView.tsx
import { useState } from 'react'
import { useNavigate } from '@tanstack/react-router'
import { MapPin } from 'lucide-react'
import { useAuthStore } from '@/stores/auth'
import MapBackground from '@/components/inspira/MapBackground'

export default function LoginView() {
  const navigate = useNavigate()
  const login = useAuthStore((s) => s.login)

  const [username, setUsername] = useState('')
  const [password, setPassword] = useState('')
  const [isLoading, setIsLoading] = useState(false)
  const [loginError, setLoginError] = useState<string | null>(null)

  async function handleLogin(e: React.FormEvent) {
    e.preventDefault()
    setIsLoading(true)
    setLoginError(null)
    try {
      await login({ username, password })
      navigate({ to: '/locations' })
    } catch (e) {
      setLoginError(
        e instanceof Error
          ? e.message.includes('401') || e.message.includes('403')
            ? '帳號或密碼錯誤'
            : e.message
          : '登入失敗，請稍後再試',
      )
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <MapBackground>
      <div className="relative z-10 w-full max-w-sm mx-4">
        <div className="card bg-base-100 shadow-xl border border-base-200">
          <div className="card-body px-8 py-8">
            <div className="flex items-center gap-3 mb-6">
              <div className="w-10 h-10 rounded-xl bg-primary flex items-center justify-center shrink-0 shadow-sm">
                <MapPin className="w-5 h-5 text-primary-content" />
              </div>
              <div>
                <h1 className="text-xl font-bold leading-none tracking-tight">skMove</h1>
                <p className="text-xs text-base-content/40 mt-0.5">路線規劃管理系統</p>
              </div>
            </div>

            <h2 className="font-semibold text-base text-base-content/70 mb-4">登入帳號</h2>

            <form onSubmit={handleLogin} className="space-y-4">
              <div className="form-control">
                <label className="label pt-0"><span className="label-text">帳號</span></label>
                <input
                  type="text"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  placeholder="請輸入帳號"
                  className="input input-bordered w-full"
                  autoComplete="username"
                  required
                />
              </div>

              <div className="form-control">
                <label className="label pt-0"><span className="label-text">密碼</span></label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  placeholder="請輸入密碼"
                  className="input input-bordered w-full"
                  autoComplete="current-password"
                  required
                />
              </div>

              {loginError && (
                <div className="alert alert-error py-2.5 text-sm">
                  <span>{loginError}</span>
                </div>
              )}

              <button
                type="submit"
                className="btn btn-primary btn-block mt-2"
                disabled={isLoading}
              >
                {isLoading && <span className="loading loading-spinner loading-xs" />}
                {isLoading ? '登入中...' : '登入'}
              </button>
            </form>
          </div>
        </div>
      </div>
    </MapBackground>
  )
}
```

---

## STEP 9 — LocationsView.tsx（示範完整 View 寫法）

```tsx
// src/views/LocationsView.tsx
import { useRef, useState } from 'react'
import { Plus, Pencil, Trash2, MapPin } from 'lucide-react'
import { useLocations, useDeleteLocation } from '@/hooks/useLocations'
import { useVehicleTypes } from '@/hooks/useVehicleTypes'
import LocationFormModal from '@/components/locations/LocationFormModal'
import { formatTimeWindow, formatLimit } from '@/lib/utils'
import type { Location } from '@/types'

export default function LocationsView() {
  const { data: locations = [], isLoading, error, refetch } = useLocations()
  const { data: vehicleTypes = [] } = useVehicleTypes()
  const deleteLocation = useDeleteLocation()

  const [showModal, setShowModal] = useState(false)
  const [editingLocation, setEditingLocation] = useState<Location | null>(null)
  const [deletingLocation, setDeletingLocation] = useState<Location | null>(null)
  const deleteDialogRef = useRef<HTMLDialogElement>(null)

  function getTypeName(id: string) {
    return vehicleTypes.find((t) => t.id === id)?.name ?? id
  }

  function openCreate() {
    setEditingLocation(null)
    setShowModal(true)
  }

  function openEdit(loc: Location) {
    setEditingLocation(loc)
    setShowModal(true)
  }

  function confirmDelete(loc: Location) {
    setDeletingLocation(loc)
    deleteDialogRef.current?.showModal()
  }

  async function handleDelete() {
    if (!deletingLocation) return
    await deleteLocation.mutateAsync(deletingLocation.id)
    deleteDialogRef.current?.close()
    setDeletingLocation(null)
  }

  return (
    <div>
      {/* Header */}
      <div className="flex items-start justify-between mb-6">
        <div>
          <h1 className="text-2xl font-bold tracking-tight">地點管理</h1>
          <p className="text-base-content/50 text-sm mt-1">新增與管理所有配送地點</p>
        </div>
        <button className="btn btn-primary gap-2" onClick={openCreate}>
          <Plus className="w-4 h-4" />
          新增地點
        </button>
      </div>

      {/* Loading */}
      {isLoading && (
        <div className="flex justify-center items-center py-16">
          <span className="loading loading-spinner loading-md text-primary" />
        </div>
      )}

      {/* Error */}
      {!isLoading && error && (
        <div className="alert alert-error">
          <span>{error.message}</span>
          <button className="btn btn-sm btn-ghost" onClick={() => refetch()}>重試</button>
        </div>
      )}

      {/* Table */}
      {!isLoading && !error && (
        <div className="card bg-base-100 shadow-sm border border-base-200">
          <div className="overflow-x-auto">
            <table className="table table-sm w-full">
              <thead>
                <tr className="border-b border-base-200 bg-base-50 text-xs text-base-content/60 uppercase tracking-wider">
                  <th className="font-semibold">地點名稱</th>
                  <th className="font-semibold">地址</th>
                  <th className="font-semibold">經緯度</th>
                  <th className="font-semibold">可收貨時窗</th>
                  <th className="font-semibold">停留時間</th>
                  <th className="font-semibold">可接受車型</th>
                  <th className="font-semibold">需求量</th>
                  <th className="font-semibold text-right">操作</th>
                </tr>
              </thead>
              <tbody>
                {locations.length === 0 ? (
                  <tr>
                    <td colSpan={8}>
                      <div className="flex flex-col items-center justify-center py-12 text-base-content/40">
                        <MapPin className="w-10 h-10 mb-3 opacity-30" />
                        <p className="font-medium">尚無地點</p>
                        <p className="text-sm mt-1">點擊右上角「新增地點」開始建立</p>
                      </div>
                    </td>
                  </tr>
                ) : locations.map((loc) => (
                  <tr key={loc.id} className="hover:bg-base-50 border-b border-base-100 last:border-0">
                    <td className="font-medium">{loc.name}</td>
                    <td className="max-w-48">
                      <span className="block truncate text-sm text-base-content/70" title={loc.address}>
                        {loc.address}
                      </span>
                    </td>
                    <td>
                      <span className="text-xs text-base-content/50 font-mono">
                        {loc.latitude.toFixed(4)},<br />{loc.longitude.toFixed(4)}
                      </span>
                    </td>
                    <td>
                      <div className="flex flex-col gap-1">
                        {loc.timeWindows.map((tw, i) => (
                          <span key={i} className="badge badge-ghost badge-sm text-xs font-normal">
                            {formatTimeWindow(tw)}
                          </span>
                        ))}
                      </div>
                    </td>
                    <td className="text-sm">{loc.dwellTime} 分</td>
                    <td>
                      <div className="flex flex-wrap gap-1">
                        {loc.acceptedVehicleTypes.map((typeId) => (
                          <span key={typeId} className="badge badge-outline badge-sm text-xs">
                            {getTypeName(typeId)}
                          </span>
                        ))}
                      </div>
                    </td>
                    <td className="text-sm font-medium">{loc.cargoDemand}</td>
                    <td>
                      <div className="flex justify-end gap-1">
                        <button
                          className="btn btn-ghost btn-xs tooltip"
                          data-tip="編輯"
                          onClick={() => openEdit(loc)}
                        >
                          <Pencil className="w-3.5 h-3.5" />
                        </button>
                        <button
                          className="btn btn-ghost btn-xs text-error/60 hover:text-error tooltip"
                          data-tip="刪除"
                          onClick={() => confirmDelete(loc)}
                        >
                          <Trash2 className="w-3.5 h-3.5" />
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {locations.length > 0 && (
            <div className="px-4 py-2.5 border-t border-base-200 text-xs text-base-content/40">
              共 {locations.length} 筆地點
            </div>
          )}
        </div>
      )}

      {/* Form Modal */}
      <LocationFormModal
        open={showModal}
        editData={editingLocation}
        onClose={() => setShowModal(false)}
      />

      {/* Delete Confirm Dialog */}
      <dialog
        ref={deleteDialogRef}
        className="modal"
        onClose={() => setDeletingLocation(null)}
      >
        <div className="modal-box max-w-sm">
          <h3 className="font-semibold text-base mb-2">確認刪除</h3>
          <p className="text-sm text-base-content/70">
            確定要刪除地點「<strong>{deletingLocation?.name}</strong>」嗎？<br />
            此操作無法復原。
          </p>
          <div className="modal-action mt-5 pt-4 border-t border-base-200">
            <button className="btn btn-ghost btn-sm" onClick={() => deleteDialogRef.current?.close()}>
              取消
            </button>
            <button
              className="btn btn-error btn-sm"
              disabled={deleteLocation.isPending}
              onClick={handleDelete}
            >
              {deleteLocation.isPending && <span className="loading loading-spinner loading-xs" />}
              確認刪除
            </button>
          </div>
        </div>
        <form method="dialog" className="modal-backdrop">
          <button>關閉</button>
        </form>
      </dialog>
    </div>
  )
}
```

> `VehiclesView.tsx` 與 `VehicleTypesView.tsx` 模式完全相同。

---

## STEP 10 — LocationFormModal.tsx（Modal 寫法示範）

> 關鍵差異：`watch(props.open)` → `useEffect([open])`；`dialogRef.value` → `dialogRef.current`。

```tsx
// src/components/locations/LocationFormModal.tsx
import { useEffect, useRef, useState } from 'react'
import { Link } from '@tanstack/react-router'
import { Plus, X } from 'lucide-react'
import { useVehicleTypes } from '@/hooks/useVehicleTypes'
import { useCreateLocation, useUpdateLocation } from '@/hooks/useLocations'
import type { Location } from '@/types'

interface Props {
  open: boolean
  editData?: Location | null
  onClose: () => void
}

type FormData = Omit<Location, 'id'>

function defaultForm(): FormData {
  return {
    name: '', address: '',
    latitude: 0, longitude: 0,
    timeWindows: [{ start: '09:00', end: '17:00' }],
    dwellTime: 15,
    acceptedVehicleTypes: [],
    cargoDemand: 0,
  }
}

export default function LocationFormModal({ open, editData, onClose }: Props) {
  const dialogRef = useRef<HTMLDialogElement>(null)
  const { data: vehicleTypes = [] } = useVehicleTypes()
  const createLocation = useCreateLocation()
  const updateLocation = useUpdateLocation()

  const [form, setForm] = useState<FormData>(defaultForm)
  const [submitError, setSubmitError] = useState<string | null>(null)

  // open/close 控制
  useEffect(() => {
    if (open) {
      setSubmitError(null)
      setForm(editData ? {
        name: editData.name,
        address: editData.address,
        latitude: editData.latitude,
        longitude: editData.longitude,
        timeWindows: editData.timeWindows.map((tw) => ({ ...tw })),
        dwellTime: editData.dwellTime,
        acceptedVehicleTypes: [...editData.acceptedVehicleTypes],
        cargoDemand: editData.cargoDemand,
      } : defaultForm())
      dialogRef.current?.showModal()
    } else {
      dialogRef.current?.close()
    }
  }, [open, editData])

  function toggleType(id: string) {
    setForm((f) => ({
      ...f,
      acceptedVehicleTypes: f.acceptedVehicleTypes.includes(id)
        ? f.acceptedVehicleTypes.filter((x) => x !== id)
        : [...f.acceptedVehicleTypes, id],
    }))
  }

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault()
    if (form.timeWindows.length === 0) { setSubmitError('至少需要一個時窗'); return }
    if (form.acceptedVehicleTypes.length === 0) { setSubmitError('至少選擇一種可接受的車輛類型'); return }

    setSubmitError(null)
    try {
      if (editData) {
        await updateLocation.mutateAsync({ id: editData.id, data: form })
      } else {
        await createLocation.mutateAsync(form)
      }
      onClose()
    } catch (e) {
      setSubmitError(e instanceof Error ? e.message : '儲存失敗，請稍後再試')
    }
  }

  const isSubmitting = createLocation.isPending || updateLocation.isPending

  return (
    <dialog ref={dialogRef} className="modal" onClose={onClose}>
      <div className="modal-box w-full max-w-2xl max-h-[92dvh] overflow-y-auto">
        <div className="flex items-center justify-between mb-5">
          <h3 className="font-semibold text-lg">{editData ? '編輯地點' : '新增地點'}</h3>
          <button className="btn btn-ghost btn-sm btn-circle" onClick={onClose}>
            <X className="w-4 h-4" />
          </button>
        </div>

        <form onSubmit={handleSubmit} className="space-y-4">
          {/* 各欄位 - 結構與 Vue 版完全相同，class → className，v-model → value/onChange */}

          {submitError && (
            <div className="alert alert-error py-2.5 text-sm">
              <span>{submitError}</span>
            </div>
          )}

          <div className="modal-action mt-2 pt-2 border-t border-base-200">
            <button type="button" className="btn btn-ghost" onClick={onClose}>取消</button>
            <button type="submit" className="btn btn-primary" disabled={isSubmitting}>
              {isSubmitting && <span className="loading loading-spinner loading-xs" />}
              {editData ? '更新地點' : '新增地點'}
            </button>
          </div>
        </form>
      </div>
      <form method="dialog" className="modal-backdrop">
        <button>關閉</button>
      </form>
    </dialog>
  )
}
```

---

## 整體執行順序

```
STEP 0  建立 Vite + React + TS 專案，安裝依賴，設定 vite.config.ts
STEP 1  複製 assets / services / types / lib（直接貼，不改）
STEP 2  建立 Zustand auth store
STEP 3  設定 TanStack Router（routes/ 目錄 + main.tsx）
STEP 4  實作 AppLayout + AppSidebar
STEP 5  移植 MapBackground.tsx（保留完整 SVG）
STEP 6  建立 TanStack Query hooks（useLocations / useVehicles / useVehicleTypes）
STEP 7  實作 LocationsView + LocationFormModal
STEP 8  實作 VehiclesView + VehicleFormModal
STEP 9  實作 VehicleTypesView + VehicleTypeModal
STEP 10 實作 LoginView（套用 MapBackground）
```

---

## 注意事項

- **SVG 屬性**：JSX 中 `stroke-width` → `strokeWidth`，`stroke-dasharray` → `strokeDasharray`
- **`<label for="">`** → `<label htmlFor="">`
- **`<dialog>` 的 `method="dialog"`**：React JSX 中直接寫，瀏覽器原生支援
- **TanStack Query**：mutation 後不需手動更新陣列，`invalidateQueries` 自動重新 fetch
- **Zustand selector**：`useAuthStore((s) => s.login)` 取單一值，避免不必要 re-render
- **TanStack Router `beforeLoad`**：用 `useAuthStore.getState()`（非 hook）讀取 store
