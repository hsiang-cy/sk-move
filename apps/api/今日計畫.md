# GraphQL Schema 完善計畫

> 依據 `src/db/schema.ts` 現況，全面改寫 `src/graphql/`

---

## 現況問題

| # | 問題 |
|---|------|
| 1 | `graphql/schema.ts` import `user`（不存在），整個 schema 已壞掉 |
| 2 | JWT payload 存 `user_id` / `user_role`，應改為 `account_id` / `account_role` |
| 3 | 除了 register/login/me，其餘 9 張表完全無對應 GraphQL |
| 4 | 所有邏輯塞在單一檔案，無法維護 |

---

## 目標檔案結構

```
src/graphql/
  schema.ts              # 主入口：組合 typeDefs + resolvers → createSchema
  context.ts             # Context type + requireAuth helper
  resolvers/
    account.ts           # register, login, me, pointLogs
    destination.ts       # Destination CRUD
    vehicle.ts           # CustomVehicleType + Vehicle CRUD
    order.ts             # Order CRUD
    compute.ts           # Compute CRUD + Route / RouteStop 查詢
```

---

## DB Table → GraphQL Type 對應

| DB Table | GraphQL Type | 備註 |
|----------|-------------|------|
| `account` | `Account` | 取代舊的 `User` |
| `point_log` | `PointLog` | 只查詢，不開放新增/修改 |
| `destination` | `Destination` | |
| `custom_vehicle_type` | `CustomVehicleType` | |
| `vehicle` | `Vehicle` | |
| `order` | `Order` | |
| `compute` | `Compute` | |
| `route` | `Route` | 只查詢（由計算引擎寫入） |
| `route_stop` | `RouteStop` | 只查詢（由計算引擎寫入） |
| `info_between_two_point` | 暫不開放 | 屬於系統內部資料 |

---

## GraphQL SDL 設計

### Scalar / Enum

```graphql
scalar JSON

enum Status        { INACTIVE ACTIVE DELETED }
enum ComputeStatus { INITIAL PENDING COMPUTING COMPLETED FAILED CANCELLED }
enum AccountRole   { ADMIN MANAGER NORMAL GUEST JUST_VIEW }
```

### Types

```graphql
type Account {
  account_id:       ID!
  status:           Status!
  account_role:     AccountRole!
  account:          String!
  email:            String!
  company_name:     String
  company_industry: String
  people_name:      String!
  phone:            String
  point:            Int!
  created_at:       Float
  updated_at:       Float
  data:             JSON
  # Field resolvers:
  point_logs:       [PointLog!]!
}

type AuthPayload {
  token:   String!
  account: Account!
}

type PointLog {
  id:         ID!
  account_id: Int!
  change:     Int!
  reason:     String!
  data:       JSON
  created_at: Float
}

type Destination {
  id:                  ID!
  account_id:          Int!
  status:              Status!
  name:                String!
  address:             String!
  lat:                 String!
  lng:                 String!
  data:                JSON
  created_at:          Float
  updated_at:          Float
  comment_for_account: String
}

type CustomVehicleType {
  id:                  ID!
  account_id:          Int!
  status:              Status!
  name:                String!
  capacity:            Int!
  data:                JSON
  created_at:          Float
  updated_at:          Float
  comment_for_account: String
}

type Vehicle {
  id:                  ID!
  account_id:          Int!
  status:              Status!
  vehicle_number:      String!
  vehicle_type:        Int!
  depot_id:            Int
  data:                JSON
  created_at:          Float
  updated_at:          Float
  comment_for_account: String
  # Field resolvers:
  vehicleTypeInfo:     CustomVehicleType
  depot:               Destination
}

type Order {
  id:                   ID!
  account_id:           Int!
  status:               Status!
  data:                 JSON
  created_at:           Float
  updated_at:           Float
  destination_snapshot: JSON!
  vehicle_snapshot:     JSON!
  comment_for_account:  String
  # Field resolver:
  computes:             [Compute!]!
}

type Compute {
  id:                  ID!
  account_id:          Int!
  order_id:            Int!
  status:              Status!
  compute_status:      ComputeStatus!
  start_time:          Float
  end_time:            Float
  fail_reason:         String
  data:                JSON
  created_at:          Float
  updated_at:          Float
  comment_for_account: String
  # Field resolver:
  routes:              [Route!]!
}

type Route {
  id:             ID!
  compute_id:     Int!
  vehicle_id:     Int!
  status:         Status!
  total_distance: Int!
  total_time:     Int!
  total_load:     Int!
  created_at:     Float
  # Field resolvers:
  vehicle:        Vehicle
  stops:          [RouteStop!]!
}

type RouteStop {
  id:             ID!
  route_id:       Int!
  destination_id: Int!
  sequence:       Int!
  arrival_time:   Int!
  demand:         Int!
  created_at:     Float
  # Field resolver:
  destination:    Destination
}
```

---

## Query / Mutation 清單

### Query

| 欄位 | 最低權限 | 說明 |
|------|---------|------|
| `me` | 無（未登入回 null） | |
| `destinations(status: Status)` | 登入 | 只回自己的資料 |
| `destination(id: ID!)` | 登入 | |
| `customVehicleTypes(status: Status)` | 登入 | |
| `customVehicleType(id: ID!)` | 登入 | |
| `vehicles(status: Status)` | 登入 | |
| `vehicle(id: ID!)` | 登入 | |
| `orders(status: Status)` | 登入 | |
| `order(id: ID!)` | 登入 | |
| `computes(orderId: ID, status: ComputeStatus)` | 登入 | |
| `compute(id: ID!)` | 登入 | |
| `pointLogs` | 登入 | |

### Mutation

| 欄位 | 最低權限 |
|------|---------|
| `register(account, email, password, people_name)` | 公開 |
| `login(account, password)` | 公開 |
| `createDestination(name, address, lat, lng, data, comment_for_account)` | `normal` |
| `updateDestination(id, name?, address?, lat?, lng?, data?, comment_for_account?)` | `normal` |
| `deleteDestination(id)` → 軟刪除 | `normal` |
| `createCustomVehicleType(name, capacity, data?, comment_for_account?)` | `normal` |
| `updateCustomVehicleType(id, name?, capacity?, data?, comment_for_account?)` | `normal` |
| `deleteCustomVehicleType(id)` → 軟刪除 | `normal` |
| `createVehicle(vehicle_number, vehicle_type, depot_id?, data?, comment_for_account?)` | `normal` |
| `updateVehicle(id, vehicle_number?, vehicle_type?, depot_id?, data?, comment_for_account?)` | `normal` |
| `deleteVehicle(id)` → 軟刪除 | `normal` |
| `createOrder(destination_snapshot, vehicle_snapshot, data?, comment_for_account?)` | `normal` |
| `deleteOrder(id)` → 軟刪除 | `normal` |
| `createCompute(order_id, data?, comment_for_account?)` | `normal` |
| `cancelCompute(id)` → compute_status = 'cancelled' | `normal` |

---

## Auth 規則

```ts
// context.ts
const ROLE_ORDER = ['just_view', 'guest', 'normal', 'manager', 'admin']

function requireAuth(user: any, minRole = 'just_view'): void {
  if (!user) throw new Error('Unauthorized')
  if (ROLE_ORDER.indexOf(user.account_role) < ROLE_ORDER.indexOf(minRole))
    throw new Error('Forbidden')
}
```

- `just_view` 角色：呼叫任何 Mutation 拋 Forbidden
- 所有查詢：過濾 `account_id = currentUser.account_id`
- 軟刪除：UPDATE `status = 'deleted'`，非真正刪除列

---

## JWT 修正

**舊（壞掉）**
```ts
sign({ user_id: ..., role: ... }, secret)
```

**新（正確）**
```ts
sign({ account_id: ..., account_role: ... }, secret)
```

`index.ts` 的 `verify()` 解出物件的 key 也對應為 `account_id` / `account_role`。

---

## Field Resolver 關聯一覽

```
Account.point_logs      → point_log WHERE account_id = parent.account_id
Vehicle.vehicleTypeInfo → custom_vehicle_type WHERE id = parent.vehicle_type
Vehicle.depot           → destination WHERE id = parent.depot_id
Order.computes          → compute WHERE order_id = parent.id
Compute.routes          → route WHERE compute_id = parent.id
Route.vehicle           → vehicle WHERE id = parent.vehicle_id
Route.stops             → route_stop WHERE route_id = parent.id (ORDER BY sequence)
RouteStop.destination   → destination WHERE id = parent.destination_id
```

---

## 實作順序

1. `context.ts` — Context type + requireAuth
2. `resolvers/account.ts` — register / login（修正 JWT key）/ me / pointLogs
3. `resolvers/destination.ts` — CRUD
4. `resolvers/vehicle.ts` — CustomVehicleType CRUD + Vehicle CRUD（含 field resolvers）
5. `resolvers/order.ts` — Order CRUD（含 field resolver computes）
6. `resolvers/compute.ts` — Compute CRUD + Route/RouteStop 查詢（含所有 field resolvers）
7. `schema.ts` — 重寫：合併 typeDefs + 所有 resolvers → `createSchema`
